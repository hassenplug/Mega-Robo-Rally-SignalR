<!DOCTYPE html>
<html>
<head>
    <title>Raspberry Pi Real-Time Dashboard</title>
    <meta charset="utf-8" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #cc3333; }
        #dataStatus, #dbStatus { padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .success { background-color: #e6ffe6; color: #008000; }
        .error { background-color: #ffe6e6; color: #cc3333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Raspberry Pi Real-Time DB Monitor</h1>
        <p>This page updates automatically when the server runs the update function.</p>
        
        <button id="updateButton">Trigger Server Update (/api/dbtest)</button>
        <p>Database Status:</p>
        <div id="dbStatus" class="error">
            Waiting for connection...
        </div>
        <p>Last Server Time:</p>
        <div id="dataStatus">N/A</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script>
        // 1. Create a connection to the SignalR Hub
        // Use relative path '/datahub' since the client and server are on the same host:port
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/datahub") 
            .build();

        // UI elements
        const dbStatusDiv = document.getElementById('dbStatus');
        const dataStatusDiv = document.getElementById('dataStatus');
        const updateButton = document.getElementById('updateButton');

        // 2. Define the function the client listens for from the server
        connection.on("ReceiveDataUpdate", function (data) {
            console.log("Data received from server:", data);
            
            // Update the Database Status area
            dbStatusDiv.textContent = data.DatabaseStatus;
            
            // Apply styling based on success/error (simple check)
            if (data.DatabaseStatus.includes("Error")) {
                dbStatusDiv.className = 'error';
            } else {
                dbStatusDiv.className = 'success';
            }

            // Update the Server Time area
            dataStatusDiv.textContent = data.ServerTime;
        });

        // 3. Start the connection
        connection.start().then(() => {
            console.log("SignalR Connected!");
            dbStatusDiv.textContent = "SignalR Connected, waiting for data...";
            dbStatusDiv.className = 'success';
        }).catch(function (err) {
            console.error(err.toString());
            dbStatusDiv.textContent = "SignalR Connection Failed! Check server console.";
            dbStatusDiv.className = 'error';
        });

        // 4. Add an event listener to the button to trigger the server function
        updateButton.addEventListener("click", function() {
            // Call the HTTP GET endpoint on the server
            fetch('/api/dbtest')
                .then(response => {
                    if (response.ok) {
                        console.log("Server update triggered.");
                    } else {
                        console.error("Failed to trigger server endpoint.");
                    }
                })
                .catch(err => console.error('Fetch error:', err));
        });

    </script>
</body>
</html>